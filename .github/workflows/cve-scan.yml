name: CVE Security Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC to catch new CVEs
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv sync

    # Scan with pip-audit (Python-specific CVE scanner)
    - name: Run pip-audit
      run: |
        uv tool install pip-audit
        uv tool run pip-audit --desc --format json --output pip-audit-report.json || true
        uv tool run pip-audit --desc || true
      continue-on-error: true

    - name: Upload pip-audit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pip-audit-report
        path: pip-audit-report.json
        retention-days: 30

    # Scan with Safety (checks against Safety DB)
    - name: Run Safety check
      run: |
        uv tool install safety
        uv tool run safety check --json --output safety-report.json || true
        uv tool run safety check || true
      continue-on-error: true

    - name: Upload Safety results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: safety-report
        path: safety-report.json
        retention-days: 30

    # Trivy scanner for comprehensive vulnerability detection
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (table format)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        severity: 'CRITICAL,HIGH,MEDIUM'

  # Optional: Create issue if vulnerabilities found
  create-issue:
    name: Create Issue for Vulnerabilities
    runs-on: ubuntu-latest
    needs: dependency-scan
    if: failure()
    
    steps:
    - name: Create Issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸš¨ Security Vulnerabilities Detected';
          const body = `## Security Scan Alert
          
          The automated CVE scan has detected potential vulnerabilities in the project dependencies.
          
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please review the scan results and update affected dependencies as soon as possible.
          
          ### Next Steps:
          1. Review the workflow artifacts for detailed reports
          2. Check the Security tab for SARIF results
          3. Update vulnerable dependencies
          4. Re-run the security scan to verify fixes
          
          ---
          *This issue was automatically created by the CVE Security Scan workflow.*`;
          
          // Check if an issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,automated'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'vulnerability']
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `New vulnerabilities detected in workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
          }

# Made with Bob
